// ==========================
// analyze.js
// ==========================
export default async function handler(req, res) {
  try {
    if (req.method !== "POST") {
      return res.status(405).json({ error: "Method not allowed" });
    }

    if (!process.env.OPENAI_API_KEY) {
      return res.status(500).json({ error: "missing_env", detail: "OPENAI_API_KEY not set" });
    }

    const { mode, aBeast, aKin, aBranch, bBeast, bKin, bBranch, context } = req.body ?? {};

    // å€‹æ€§ç‰¹å¾µåº«
    const beastTraits = {
      "é’é¾": "éˆæ´»å¤šè®Šã€åæ‡‰è¿…é€Ÿï¼Œå–œæ­¡æŒ‘æˆ°èˆ‡å‰µæ–°ã€‚",
      "æœ±é›€": "è¡¨é”åŠ›å¼·ã€æƒ…æ„Ÿå¤–æ”¾ï¼Œå®¹æ˜“æ„ŸæŸ“å‘¨åœçš„äººã€‚",
      "å‹¾é™³": "ç©©é‡è¸å¯¦ã€æ¬Šå¨æ„Ÿå¼·ï¼Œé‡è¦–ç§©åºèˆ‡è¦ç¯„ã€‚",
      "è£è›‡": "å¤šç–‘æ©Ÿå·§ã€å–„æ–¼éš±è—ï¼Œèƒ½æ´æ‚‰éš±å¾®ä¹‹è™•ã€‚",
      "ç™½è™": "å‰›çƒˆæœæ±ºã€è¡Œå‹•è¿…é€Ÿï¼Œå¸¶æœ‰å£“è¿«èˆ‡éœ‡æ‡¾æ„Ÿã€‚",
      "ç„æ­¦": "éš±å¿æ·±æ²‰ã€è¬€ç•¥éäººï¼Œåå‘è¢«å‹•è§€å¯Ÿèˆ‡é˜²ç¦¦ã€‚"
    };

    const kinTraits = {
      "çˆ¶æ¯": "ä¾é ã€æ”¯æŒèˆ‡çŸ¥è­˜ä¾†æºï¼Œæ³¨é‡è²¬ä»»èˆ‡å‚³æ‰¿ã€‚",
      "å…„å¼Ÿ": "ç«¶çˆ­èˆ‡åˆä½œä¸¦å­˜ï¼Œè±¡å¾µå¹³ç­‰èˆ‡è¡çªã€‚",
      "å­å­«": "å‰µæ„èˆ‡ç™¼å±•ï¼Œä»£è¡¨æœªä¾†å¸Œæœ›èˆ‡ä¿è­·ã€‚",
      "å¦»è²¡": "è³‡æºèˆ‡åˆ©ç›Šï¼Œèˆ‡äººéš›äº¤æ›å¯†åˆ‡ç›¸é—œã€‚",
      "å®˜é¬¼": "å£“åŠ›ã€è²¬ä»»èˆ‡æŒ‘æˆ°ï¼ŒåŒæ™‚ä¹Ÿæ˜¯æ¬ŠåŠ›çš„è±¡å¾µã€‚"
    };

    const branchTraits = {
      "å­": "è°æ˜éˆå·§ï¼Œå–„æ–¼éš±å¿ï¼Œä½†å¿ƒæ€è¤‡é›œã€‚",
      "ä¸‘": "å‹™å¯¦å›ºåŸ·ï¼Œåå‘ç©©å¥ï¼Œå°‘æœ‰å†’éšªã€‚",
      "å¯…": "å‹‡æ•¢æœæ–·ï¼Œå……æ»¿è¡å‹ï¼Œç•¥é¡¯æ€¥èºã€‚",
      "å¯": "éˆæ´»æŸ”è»Ÿï¼Œæ“…äº¤éš›ï¼Œæ„Ÿæ€§å¤šæ€ã€‚",
      "è¾°": "ç¥ç¥•ä¸­åº¸ï¼Œèƒ½èª¿å’ŒçŸ›ç›¾ï¼Œäº¦æœ‰åŸ·æ‹—ã€‚",
      "å·³": "æ€ç¶­ç¸å¯†ï¼Œå–„æ–¼åˆ¤æ–·ï¼Œæƒ…ç·’å…§æ–‚ã€‚",
      "åˆ": "ç†±æƒ…å¤–æ”¾ï¼Œå……æ»¿æ´»åŠ›ï¼Œä½†æ˜“è¡å‹•ã€‚",
      "æœª": "éš¨å’Œè€å¿ƒï¼Œæ¨‚æ–¼å”åŠ©ï¼Œå»ç¼ºä¹ä¸»è¦‹ã€‚",
      "ç”³": "æ©Ÿæ•å¤šè¬€ï¼Œå–„æ–¼éš¨æ©Ÿæ‡‰è®Šï¼Œæ€è·¯éˆæ´»ã€‚",
      "é…‰": "æ³¨é‡ç´°ç¯€ï¼Œæ“…æ–¼è¦åŠƒï¼Œä½†æ˜“éæ–¼æŒ‘å‰”ã€‚",
      "æˆŒ": "é‡æƒ…é‡ç¾©ï¼Œè¬›ç©¶èª ä¿¡ï¼Œä½†å›ºåŸ·ä¸åŒ–ã€‚",
      "äº¥": "å¿ƒæ€§æº«å’Œï¼Œå¯Œæ–¼åŒç†ï¼Œä½†æ„å¿—ä¸å¤ å …å®šã€‚"
    };

    // çµ„åˆè§’è‰²å€‹æ€§æè¿°
    function getPersonality(beast, kin, branch) {
      return `${beast}ï¼š${beastTraits[beast]}\n${kin}ï¼š${kinTraits[kin]}\n${branch}ï¼š${branchTraits[branch]}`;
    }

    // åˆ†ææ ¼å¼
    let output = "";
    if (context === "è·å ´") {
      output = `
ğŸ“Šã€è·å ´åˆ†æã€‘
è§’è‰²ç‰¹è³ªï¼š
${getPersonality(aBeast, aKin, aBranch)}

${mode === "dual" ? `â¤ å°æ‰‹ç‰¹è³ªï¼š\n${getPersonality(bBeast, bKin, bBranch)}` : ""}

äº’å‹•æ¨¡å¼è§£æï¼š
- ä¸Šå¸å‚¾å‘ï¼šæ¬Šå¨ï¼è¦åŠƒï¼æ±ºæ–·
- ä¸‹å±¬å‚¾å‘ï¼šåŸ·è¡Œï¼æ‡‰è®Šï¼æœå¾

ğŸ“Œ å»ºè­°ï¼š
1. é¿å…æ­£é¢è¡çªï¼Œå–„ç”¨äº’è£œå„ªå‹¢ã€‚
2. å»ºç«‹æ¸…æ™°çš„è²¬ä»»åˆ†å·¥ã€‚
      `;
    } else if (context === "æ„›æƒ…") {
      output = `
ğŸ’–ã€æ„›æƒ…åˆ†æã€‘
è§’è‰²ç‰¹è³ªï¼š
${getPersonality(aBeast, aKin, aBranch)}

${mode === "dual" ? `â¤ å°è±¡ç‰¹è³ªï¼š\n${getPersonality(bBeast, bKin, bBranch)}` : ""}

æƒ…æ„Ÿäº’å‹•ï¼š
- æƒ…æ„›æŒ‡æ•¸ï¼š${Math.floor(Math.random()*3)+7}/10
- é»˜å¥‘æŒ‡æ•¸ï¼š${Math.floor(Math.random()*3)+6}/10

ğŸ“Œ å»ºè­°ï¼š
1. å¤šç”¨çœŸèª æºé€šåŒ–è§£èª¤æœƒã€‚
2. æƒ…æ„Ÿä¸­é¿å…çŒœå¿Œèˆ‡å†·æ¼ ã€‚
      `;
    } else if (context === "æ€§æ„›") {
      output = `
ğŸ”¥ã€æ€§æ„›åˆ†æã€‘
è§’è‰²ç‰¹è³ªï¼š
${getPersonality(aBeast, aKin, aBranch)}

${mode === "dual" ? `â¤ å°è±¡ç‰¹è³ªï¼š\n${getPersonality(bBeast, bKin, bBranch)}` : ""}

äº’å‹•æ¨¡å¼ï¼š
- æ¿€æƒ…æŒ‡æ•¸ï¼š${Math.floor(Math.random()*3)+7}/10
- å’Œè«§æŒ‡æ•¸ï¼š${Math.floor(Math.random()*3)+6}/10

æ¨è–¦é«”ä½ï¼š
- ${["å¥³ä¸Šä½","å¾Œå…¥å¼","å´èº«äº¤çº","åå§¿äº¤ç–Š"][Math.floor(Math.random()*4)]}
- ${["ç«™ç«‹æ“æŠ±","åå‘é¨ä¹˜","äº¤éŒ¯ä¸¦è…¿","åºŠé‚Šæ”¯æ’"][Math.floor(Math.random()*4)]}
      `;
    } else if (context === "å€‹æ€§") {
      output = `
ğŸ§©ã€å€‹æ€§åˆ†æã€‘
è§’è‰²ç‰¹è³ªï¼š
${getPersonality(aBeast, aKin, aBranch)}

ğŸ”‘ æ ¸å¿ƒæ€§æ ¼ï¼š
- å„ªé»ï¼šå …æ¯… / å‰µæ„ / æ„Ÿæ€§
- å¼±é»ï¼šå›ºåŸ· / éåº¦æƒ…ç·’åŒ–

ğŸ“Œ å»ºè­°ï¼š
- åœ¨é©åˆçš„é ˜åŸŸç™¼æ®é•·è™•ã€‚
- å­¸æœƒæƒ…ç·’ç®¡ç†ï¼Œé¿å…æ¶ˆè€—éå¤šèƒ½é‡ã€‚
      `;
    }

    // å›å‚³ JSON + é›·é”åœ–æ•¸æ“š
    const radarData = {
      "æƒ…æ„Ÿ": Math.floor(Math.random() * 10) + 1,
      "äº‹æ¥­": Math.floor(Math.random() * 10) + 1,
      "å¥åº·": Math.floor(Math.random() * 10) + 1,
      "è²¡é‹": Math.floor(Math.random() * 10) + 1,
      "æ™ºæ…§": Math.floor(Math.random() * 10) + 1
    };

    res.status(200).json({
      text: output,
      radar: radarData
    });

  } catch (err) {
    res.status(500).json({ error: "Server error", detail: err.message });
  }
}
