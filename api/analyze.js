// ==========================
//   æ–‡ä»¶ï¼šapi/analyze.js
// ==========================
export default async function handler(req, res) {
  try {
    if (req.method !== "POST") {
      return res.status(405).json({ error: "Method not allowed" });
    }

    if (!process.env.OPENAI_API_KEY) {
      return res.status(500).json({ error: "missing_env", detail: "OPENAI_API_KEY not set" });
    }

    const { mode, aBeast, aKin, aBranch, bBeast, bKin, bBranch, context } = req.body ?? {};

    // å›ºå®šæ ¼å¼æ¨¡æ¿
    const prompts = {
      career: `
ä½ æ˜¯ä¸€ä½å…­ç¸é‡‘éŒ¢å¦å åœå¸«ï¼Œè«‹é‡å°ã€Œè·å ´ç¯‡ã€ç”Ÿæˆåˆ†æã€‚
è«‹ä¾ç…§ä»¥ä¸‹æ ¼å¼è¼¸å‡º HTMLï¼š

ğŸ‰ {ä¸Šå¸å…­ç¸}{ä¸Šå¸åœ°æ”¯}{ä¸Šå¸å…­è¦ª} VS {ä¸‹å±¬å…­ç¸}{ä¸‹å±¬åœ°æ”¯}{ä¸‹å±¬å…­è¦ª}

<h3>é›™å±¤è§’è‰²è¨­å®š</h3>
<ul>
<li>{ä¸Šå¸å…­ç¸}ç‰¹è³ªï¼šä¾ç…§å…­ç¸ç‰¹è³ªè£œå……ã€‚</li>
<li>{ä¸Šå¸åœ°æ”¯}ç‰¹è³ªï¼šä¾ç…§åœ°æ”¯ç‰¹è³ªè£œå……ã€‚</li>
<li>{ä¸‹å±¬å…­ç¸}ç‰¹è³ªï¼šä¾ç…§å…­ç¸ç‰¹è³ªè£œå……ã€‚</li>
<li>{ä¸‹å±¬åœ°æ”¯}ç‰¹è³ªï¼šä¾ç…§åœ°æ”¯ç‰¹è³ªè£œå……ã€‚</li>
</ul>

<h3>äº’å‹•æ¨¡å¼åˆ†æ</h3>
<ul>
<li>ä¸Šå¸{ä¸Šå¸å…­ç¸}{ä¸Šå¸åœ°æ”¯}ï¼šæè¿°è¡Œäº‹é¢¨æ ¼ã€‚</li>
<li>ä¸‹å±¬{ä¸‹å±¬å…­ç¸}{ä¸‹å±¬åœ°æ”¯}ï¼šæè¿°è¡Œäº‹é¢¨æ ¼ã€‚</li>
<li>é›™æ–¹äº’å‹•æ¨¡å¼ï¼šè£œä¸Šè¡çªèˆ‡åˆä½œé‡é»ã€‚</li>
</ul>

<h3>é«˜å±è¡çªé»</h3>
<ul>
<li>èª°çš„æˆ°è¡“å„ªå…ˆï¼Ÿ</li>
<li>åŠŸå‹æ­¸å±¬æˆ°ã€‚</li>
<li>æœªä¾†ç™¼å±•çŒœå¿Œã€‚</li>
</ul>

<h3>é›™å‘æ‡‰å°ç­–ç•¥</h3>
âœ… ä¸Šå¸ç‰ˆï¼š3æ¢å…·é«”å»ºè­°  
âœ… ä¸‹å±¬ç‰ˆï¼š3æ¢å…·é«”å»ºè­°  

<h3>æƒ…å¢ƒå°è©±</h3>
<p>ä¸Šå¸ï¼šã€Œ...ã€<br>ä¸‹å±¬ï¼šã€Œ...ã€</p>

<h3>ç¶“å…¸é¿å‘æé†’</h3>
<ul>
<li>æé†’1</li>
<li>æé†’2</li>
<li>æé†’3</li>
</ul>
      `,
      love: `
è«‹é‡å°ã€Œæ„›æƒ…ç¯‡ã€ç”Ÿæˆåˆ†æï¼Œè¼¸å‡º HTML æ ¼å¼ï¼š

ğŸ’ {ç”²æ–¹å…­ç¸}{ç”²åœ°æ–¹}{ç”²å…­è¦ª} X {ä¹™æ–¹å…­ç¸}{ä¹™åœ°æ–¹}{ä¹™å…­è¦ª}

<h3>æ„›æƒ…äº’å‹•ç‰¹è‰²</h3>
<ul><li>ç”²æ–¹ï¼šæè¿°å€‹æ€§èˆ‡æ„›æƒ…ç¿’æ…£ã€‚</li>
<li>ä¹™æ–¹ï¼šæè¿°å€‹æ€§èˆ‡æ„›æƒ…ç¿’æ…£ã€‚</li></ul>

<h3>ç”œèœœåŠ åˆ†é»</h3>
<ul><li>åŠ åˆ†é»1</li><li>åŠ åˆ†é»2</li><li>åŠ åˆ†é»3</li></ul>

<h3>éš±è—å±æ©Ÿ</h3>
<ul><li>å±æ©Ÿ1</li><li>å±æ©Ÿ2</li></ul>

<h3>æœ€ä½³ç›¸è™•å»ºè­°</h3>
<ul><li>å»ºè­°1</li><li>å»ºè­°2</li></ul>
      `,
      sex: `
è«‹é‡å°ã€Œæ€§æ„›ç¯‡ã€ç”Ÿæˆåˆ†æï¼Œè¼¸å‡º HTML æ ¼å¼ï¼š

ğŸ”¥ {ç”²æ–¹å…­ç¸}{ç”²åœ°æ–¹}{ç”²å…­è¦ª} X {ä¹™æ–¹å…­ç¸}{ä¹™åœ°æ–¹}{ä¹™å…­è¦ª}

<h3>æƒ…æ„›æŒ‡æ•¸</h3>
<p>ï¼ˆæ•¸å­—0-10ï¼Œä¸¦é™„ä¸€å¥æè¿°ï¼‰</p>

<h3>äº’å‹•æ¨¡å¼</h3>
<p>æè¿°é›™æ–¹åœ¨æ€§æ„›äº’å‹•çš„ç‰¹é»ã€‚</p>

<h3>é›·é»åˆ†æ</h3>
<p>æè¿°æ½›åœ¨è¡çªã€‚</p>

<h3>æœ€ä½³æ€§æ„›åŠ‡æœ¬æ¨è–¦</h3>
<ul><li>åŠ‡æœ¬1</li><li>åŠ‡æœ¬2</li></ul>

<h3>æ¨è–¦é«”ä½</h3>
<ul><li>é«”ä½1</li><li>é«”ä½2</li></ul>

<h3>æ¨è–¦æƒ…è¶£å…ƒç´ </h3>
<ul><li>å…§è¡£/æœè£</li><li>ç©å…·</li><li>å ´æ™¯</li></ul>
      `,
      personality: `
è«‹é‡å°ã€Œå€‹æ€§ç¯‡ã€ç”Ÿæˆåˆ†æï¼Œè¼¸å‡º HTML æ ¼å¼ï¼š

ğŸŒŸ {å–®äººå…­ç¸}{å–®äººåœ°æ”¯}{å–®äººå…­è¦ª}

<h3>å…­ç¸å€‹æ€§</h3>
<p>æè¿°å…­ç¸çš„è¡Œç‚ºæ¨¡å¼èˆ‡æ€§æ ¼ç‰¹é»ã€‚</p>

<h3>å…­è¦ªå‚¾å‘</h3>
<p>æè¿°å…­è¦ªåœ¨å€‹æ€§ä¸Šçš„å‚¾å‘èˆ‡ç¿’æ…£ã€‚</p>

<h3>åœ°æ”¯èƒ½é‡</h3>
<p>æè¿°æ­¤åœ°æ”¯å°æ–¼æ€ç¶­èˆ‡ç¿’æ€§çš„å½±éŸ¿ã€‚</p>

<h3>ç¶œåˆè©•èª</h3>
<p>æ•´é«”æ€§æ ¼è©•ä¼°ã€‚</p>
      `
    };

    // é¸æ“‡æ¨¡æ¿
    const prompt = prompts[context] || "è«‹ç”¢ç”Ÿåˆ†æå…§å®¹";

    // å‘¼å« OpenAI API
    const response = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${process.env.OPENAI_API_KEY}`
      },
      body: JSON.stringify({
        model: "gpt-4o-mini",
        messages: [{
          role: "system",
          content: "ä½ æ˜¯å°ˆæ¥­å…­ç¸é‡‘éŒ¢å¦å åœåˆ†æå¸«ï¼Œè«‹ç”¨ç¹é«”ä¸­æ–‡è¼¸å‡ºï¼Œä¸”å¿…é ˆè¼¸å‡º HTML æ ¼å¼ã€‚"
        }, {
          role: "user",
          content: prompt
            .replace(/{ä¸Šå¸å…­ç¸}/g, aBeast || "")
            .replace(/{ä¸Šå¸åœ°æ”¯}/g, aBranch || "")
            .replace(/{ä¸Šå¸å…­è¦ª}/g, aKin || "")
            .replace(/{ä¸‹å±¬å…­ç¸}/g, bBeast || "")
            .replace(/{ä¸‹å±¬åœ°æ”¯}/g, bBranch || "")
            .replace(/{ä¸‹å±¬å…­è¦ª}/g, bKin || "")
            .replace(/{ç”²æ–¹å…­ç¸}/g, aBeast || "")
            .replace(/{ç”²åœ°æ–¹}/g, aBranch || "")
            .replace(/{ç”²å…­è¦ª}/g, aKin || "")
            .replace(/{ä¹™æ–¹å…­ç¸}/g, bBeast || "")
            .replace(/{ä¹™åœ°æ–¹}/g, bBranch || "")
            .replace(/{ä¹™å…­è¦ª}/g, bKin || "")
            .replace(/{å–®äººå…­ç¸}/g, aBeast || "")
            .replace(/{å–®äººåœ°æ”¯}/g, aBranch || "")
            .replace(/{å–®äººå…­è¦ª}/g, aKin || "")
        }]
      })
    });

    const data = await response.json();
    const analysis = data.choices?.[0]?.message?.content ?? "âš  ç„¡æ³•ç”Ÿæˆåˆ†æ";

    // æ¨¡æ“¬é›·é”åœ–æ•¸æ“šï¼ˆé€™è£¡ä¹Ÿå¯ä»¥æ”¹ç”± AI å›å‚³ JSONï¼‰
    const scores = {
      æƒ…æ„Ÿ: Math.floor(Math.random() * 40) + 60,
      äº‹æ¥­: Math.floor(Math.random() * 40) + 60,
      äººéš›: Math.floor(Math.random() * 40) + 60,
      å¥åº·: Math.floor(Math.random() * 40) + 60,
      éˆæ€§: Math.floor(Math.random() * 40) + 60
    };

    res.status(200).json({ analysis, scores });
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: "internal_error", detail: err.message });
  }
}
