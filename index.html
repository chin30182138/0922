<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ä»™äººæŒ‡è·¯ å…­ç¸å€‹æ€§åˆ†æ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    @media print {
      @page { margin: 14mm; }
      .no-print { display:none !important; }
      body { background:#fff !important; }
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="max-w-6xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">ğŸ”® ä»™äººæŒ‡è·¯ å…­ç¸å€‹æ€§åˆ†æç³»çµ±</h1>

    <!-- æ¨¡å¼åˆ‡æ› -->
    <div class="mb-4">
      <button onclick="setMode('single')" class="px-4 py-2 bg-indigo-500 text-white rounded">å–®äººåˆ†æ</button>
      <button onclick="setMode('dual')" class="px-4 py-2 bg-pink-500 text-white rounded">é›™äººåˆ†æ</button>
    </div>

    <!-- å–®äººè¼¸å…¥ -->
    <div id="singleInput" class="grid grid-cols-3 gap-4 mb-4">
      <div>
        <label class="block text-lg font-semibold">å…­ç¸</label>
        <select id="aBeast" class="w-full border p-2 text-lg">
          <option>é’é¾</option><option>æœ±é›€</option><option>å‹¾é™³</option>
          <option>è£è›‡</option><option>ç™½è™</option><option>ç„æ­¦</option>
        </select>
      </div>
      <div>
        <label class="block text-lg font-semibold">å…­è¦ª</label>
        <select id="aKin" class="w-full border p-2 text-lg">
          <option>çˆ¶æ¯</option><option>å…„å¼Ÿ</option><option>å­å­«</option>
          <option>å¦»è²¡</option><option>å®˜é¬¼</option>
        </select>
      </div>
      <div>
        <label class="block text-lg font-semibold">åœ°æ”¯</label>
        <select id="aBranch" class="w-full border p-2 text-lg">
          <option>å­</option><option>ä¸‘</option><option>å¯…</option><option>å¯</option>
          <option>è¾°</option><option>å·³</option><option>åˆ</option><option>æœª</option>
          <option>ç”³</option><option>é…‰</option><option>æˆŒ</option><option>äº¥</option>
        </select>
      </div>
    </div>

    <!-- é›™äººè¼¸å…¥ -->
    <div id="dualInput" class="grid grid-cols-6 gap-4 mb-4 hidden">
      <div>
        <label class="block text-lg font-semibold">ç”² å…­ç¸</label>
        <select id="aBeastDual" class="w-full border p-2 text-lg">
          <option>é’é¾</option><option>æœ±é›€</option><option>å‹¾é™³</option>
          <option>è£è›‡</option><option>ç™½è™</option><option>ç„æ­¦</option>
        </select>
      </div>
      <div>
        <label class="block text-lg font-semibold">ç”² å…­è¦ª</label>
        <select id="aKinDual" class="w-full border p-2 text-lg">
          <option>çˆ¶æ¯</option><option>å…„å¼Ÿ</option><option>å­å­«</option>
          <option>å¦»è²¡</option><option>å®˜é¬¼</option>
        </select>
      </div>
      <div>
        <label class="block text-lg font-semibold">ç”² åœ°æ”¯</label>
        <select id="aBranchDual" class="w-full border p-2 text-lg">
          <option>å­</option><option>ä¸‘</option><option>å¯…</option><option>å¯</option>
          <option>è¾°</option><option>å·³</option><option>åˆ</option><option>æœª</option>
          <option>ç”³</option><option>é…‰</option><option>æˆŒ</option><option>äº¥</option>
        </select>
      </div>
      <div>
        <label class="block text-lg font-semibold">ä¹™ å…­ç¸</label>
        <select id="bBeastDual" class="w-full border p-2 text-lg">
          <option>é’é¾</option><option>æœ±é›€</option><option>å‹¾é™³</option>
          <option>è£è›‡</option><option>ç™½è™</option><option>ç„æ­¦</option>
        </select>
      </div>
      <div>
        <label class="block text-lg font-semibold">ä¹™ å…­è¦ª</label>
        <select id="bKinDual" class="w-full border p-2 text-lg">
          <option>çˆ¶æ¯</option><option>å…„å¼Ÿ</option><option>å­å­«</option>
          <option>å¦»è²¡</option><option>å®˜é¬¼</option>
        </select>
      </div>
      <div>
        <label class="block text-lg font-semibold">ä¹™ åœ°æ”¯</label>
        <select id="bBranchDual" class="w-full border p-2 text-lg">
          <option>å­</option><option>ä¸‘</option><option>å¯…</option><option>å¯</option>
          <option>è¾°</option><option>å·³</option><option>åˆ</option><option>æœª</option>
          <option>ç”³</option><option>é…‰</option><option>æˆŒ</option><option>äº¥</option>
        </select>
      </div>
    </div>

    <!-- æ“ä½œæŒ‰éˆ• -->
    <div class="flex flex-wrap gap-4 mb-6 no-print">
      <button onclick="runAnalysis('career')" class="px-4 py-2 bg-green-500 text-white rounded">è·å ´åˆ†æ</button>
      <button onclick="runAnalysis('love')" class="px-4 py-2 bg-pink-500 text-white rounded">æ„›æƒ…åˆ†æ</button>
      <button onclick="runAnalysis('sex')" class="px-4 py-2 bg-red-500 text-white rounded">æ€§æ„›åˆ†æ</button>
      <button onclick="runAnalysis('personality')" class="px-4 py-2 bg-indigo-500 text-white rounded">å€‹æ€§åˆ†æ</button>

      <button onclick="window.print()" class="px-4 py-2 bg-gray-600 text-white rounded">ğŸ–¨ åˆ—å°</button>
      <input type="text" id="pdfName" placeholder="è¼¸å…¥æª”å" class="border p-2 rounded"/>
      <button onclick="downloadPDF()" class="px-4 py-2 bg-purple-600 text-white rounded">â¬‡ PDF</button>
    </div>

    <!-- é¡è‰²è¨­å®š -->
    <div class="flex gap-6 mb-6 flex-wrap">
      <div>
        <label class="block text-sm font-bold">é›·é”åœ–é¡è‰²</label>
        <select id="colorSelect" class="mt-1 p-2 border rounded bg-yellow-50">
          <option value="rgba(255,99,132,0.5)">ç´…è‰²</option>
          <option value="rgba(54,162,235,0.5)">è—è‰²</option>
          <option value="rgba(75,192,192,0.5)">ç¶ è‰²</option>
          <option value="rgba(255,206,86,0.5)">é»ƒè‰²</option>
          <option value="rgba(153,102,255,0.5)">ç´«è‰²</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-bold">èƒŒæ™¯é¡è‰²</label>
        <input type="color" id="bgPicker" value="#fff0f5" class="mt-1 h-10 w-20 border rounded">
      </div>
    </div>

    <!-- åˆ†æè¼¸å‡º -->
    <div id="reportArea" class="bg-white p-4 rounded shadow">
      <div id="progressBar" class="w-full bg-gray-200 rounded-full h-4 mb-4 hidden">
        <div id="progressFill" class="h-4 bg-blue-500 rounded-full text-xs text-white text-center">0%</div>
      </div>
      <div id="analysisResult" class="prose max-w-none"></div>
      <canvas id="radarChart" class="mt-6"></canvas>
    </div>
  </div>

  <script>
    let mode = "single";
    let radarChart;

    function setMode(m) {
      mode = m;
      document.getElementById("singleInput").classList.toggle("hidden", m !== "single");
      document.getElementById("dualInput").classList.toggle("hidden", m !== "dual");
    }

    async function runAnalysis(type) {
      document.getElementById("progressBar").classList.remove("hidden");
      let progress = 0;
      const interval = setInterval(() => {
        progress += 5;
        document.getElementById("progressFill").style.width = progress + "%";
        document.getElementById("progressFill").innerText = progress + "%";
        if (progress >= 100) clearInterval(interval);
      }, 120);

      // çµ„åˆåƒæ•¸
      const body = {
        mode,
        context: type,
        aBeast: document.getElementById("aBeast")?.value,
        aKin: document.getElementById("aKin")?.value,
        aBranch: document.getElementById("aBranch")?.value,
        bBeast: document.getElementById("bBeastDual")?.value,
        bKin: document.getElementById("bKinDual")?.value,
        bBranch: document.getElementById("bBranchDual")?.value
      };

      try {
        const res = await fetch("/api/analyze", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        const data = await res.json();

        // æ’å…¥åˆ†æå…§å®¹
        document.getElementById("analysisResult").innerHTML = data.analysis;

        // ç•«é›·é”åœ–
        if (data.scores) {
          renderRadar(Object.values(data.scores));
        }
      } catch (err) {
        document.getElementById("analysisResult").innerHTML = "<p>âš  åˆ†æå¤±æ•—</p>";
      }
    }

    function renderRadar(scores) {
      const ctx = document.getElementById("radarChart").getContext("2d");
      if (radarChart) radarChart.destroy();
      radarChart = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: ["æƒ…æ„Ÿ", "äº‹æ¥­", "äººéš›", "å¥åº·", "éˆæ€§"],
          datasets: [{
            label: "åˆ†æåˆ†æ•¸",
            data: scores,
            backgroundColor: document.getElementById("colorSelect").value,
            borderColor: "#333",
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          scales: { r: { min: 0, max: 100, ticks: { stepSize: 20 } } }
        }
      });
    }

    document.getElementById("colorSelect").addEventListener("change", e => {
      if (radarChart) {
        radarChart.data.datasets[0].backgroundColor = e.target.value;
        radarChart.update();
      }
    });

    document.getElementById("bgPicker").addEventListener("input", e => {
      document.body.style.background = e.target.value;
    });

    function downloadPDF() {
      const name = document.getElementById("pdfName").value || "å…­ç¸åˆ†æå ±å‘Š";
      const element = document.getElementById("reportArea");
      const opt = {
        margin: 0.5,
        filename: name + ".pdf",
        image: { type: "jpeg", quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: "in", format: "a4", orientation: "portrait" }
      };
      html2pdf().set(opt).from(element).save();
    }
  </script>
</body>
</html>
