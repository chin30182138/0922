<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>六獸個性預測分析</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    @media print {
      @page { margin: 14mm; }
      body { background:#fff !important; }
      .no-print { display:none !important; }
      .print-card { box-shadow:none !important; border:1px solid #e5e7eb; }
    }
  </style>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-3xl mx-auto bg-white p-6 rounded shadow">
    <h1 class="text-2xl font-bold mb-4">六獸個性預測</h1>

    <!-- 分析模式選擇 -->
    <div class="mb-4">
      <label class="font-semibold">分析模式：</label>
      <select id="mode" class="border rounded p-2">
        <option value="single">單人分析</option>
        <option value="double">雙人分析</option>
      </select>
    </div>

    <!-- 角色選擇 -->
    <div id="single-inputs" class="mb-4">
      <input id="aBeast" placeholder="六獸 (例：青龍)" class="border rounded p-2 mr-2" />
      <input id="aBranch" placeholder="地支 (例：子)" class="border rounded p-2 mr-2" />
    </div>

    <div id="double-inputs" class="mb-4 hidden">
      <input id="bBeast" placeholder="對方六獸 (例：朱雀)" class="border rounded p-2 mr-2" />
      <input id="bBranch" placeholder="對方地支 (例：寅)" class="border rounded p-2 mr-2" />
    </div>

    <!-- 情境選擇 -->
    <div class="mb-4">
      <label class="font-semibold">情境：</label>
      <select id="context" class="border rounded p-2">
        <option value="綜合">綜合</option>
        <option value="職場">職場</option>
        <option value="人際關係">人際關係</option>
        <option value="愛情">愛情</option>
        <option value="性愛">性愛</option>
      </select>
    </div>

    <!-- 分析按鈕 -->
    <button onclick="startAnalysis()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">開始分析</button>

    <!-- 進度條 -->
    <div id="progress" class="w-full bg-gray-200 rounded mt-4 hidden">
      <div id="progress-bar" class="bg-blue-600 text-xs leading-none py-1 text-center text-white rounded w-0">0%</div>
    </div>

    <!-- 分析結果 -->
    <div id="result" class="mt-6 hidden print-card p-4 border rounded shadow">
      <div id="result-text" class="whitespace-pre-line mb-4 text-sm"></div>
      <canvas id="radarChart" width="300" height="300"></canvas>

      <!-- 列印與下載 PDF -->
      <div class="mt-4 flex gap-4">
        <button onclick="printResult()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 no-print">
          列印分析結果
        </button>
        <button onclick="downloadPDF()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 no-print">
          下載 PDF
        </button>
      </div>
    </div>
  </div>

<script>
let chartInstance = null;

// 顯示進度條
async function startAnalysis() {
  document.getElementById("progress").classList.remove("hidden");
  let progress = 0;
  const interval = setInterval(() => {
    if (progress < 90) {
      progress += 10;
      updateProgress(progress);
    }
  }, 300);

  const mode = document.getElementById("mode").value;
  const aBeast = document.getElementById("aBeast").value || "青龍";
  const aBranch = document.getElementById("aBranch").value || "子";
  const bBeast = document.getElementById("bBeast").value || "朱雀";
  const bBranch = document.getElementById("bBranch").value || "寅";
  const context = document.getElementById("context").value;

  const response = await fetch("/api/analyze", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ mode, aBeast, aBranch, bBeast, bBranch, context })
  });
  const data = await response.json();

  clearInterval(interval);
  updateProgress(100);

  showResult(data.text, data.scores);
}

function updateProgress(value) {
  const bar = document.getElementById("progress-bar");
  bar.style.width = value + "%";
  bar.innerText = value + "%";
}

// 顯示結果
function showResult(text, scores) {
  document.getElementById("result").classList.remove("hidden");
  document.getElementById("result-text").innerHTML = text.replace(/\n/g, "<br>");
  drawRadar(scores);
}

// 畫雷達圖
function drawRadar(scores) {
  const ctx = document.getElementById("radarChart").getContext("2d");
  if (chartInstance) chartInstance.destroy();
  const labels = ["情感", "事業", "健康", "財運", "智慧"];
  const values = labels.map(l => scores && scores[l] ? scores[l] : 0);
  chartInstance = new Chart(ctx, {
    type: "radar",
    data: {
      labels: labels,
      datasets: [{
        label: "能量分布",
        data: values,
        fill: true,
        borderColor: "rgba(54,162,235,1)",
        backgroundColor: "rgba(54,162,235,0.2)"
      }]
    },
    options: { responsive: true, scales: { r: { beginAtZero: true, max: 10 } } }
  });
}

// 列印
function printResult() {
  window.print();
}

// 下載 PDF
function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  const text = document.getElementById("result-text").innerText;
  pdf.setFontSize(12);
  pdf.text(text, 10, 20);

  // 匯出雷達圖
  const canvas = document.getElementById("radarChart");
  const imgData = canvas.toDataURL("image/png");
  pdf.addImage(imgData, "PNG", 10, 80, 180, 120);

  pdf.save("分析結果.pdf");
}

// 切換單人 / 雙人
document.getElementById("mode").addEventListener("change", function() {
  if (this.value === "single") {
    document.getElementById("single-inputs").classList.remove("hidden");
    document.getElementById("double-inputs").classList.add("hidden");
  } else {
    document.getElementById("single-inputs").classList.remove("hidden");
    document.getElementById("double-inputs").classList.remove("hidden");
  }
});
</script>
</body>
</html>
