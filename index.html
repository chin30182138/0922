<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>仙人指路神獸七十二型人格 一鍵分析</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    /* 基本分數條樣式 */
    .scores{display:grid;grid-template-columns:1fr;gap:8px;margin-top:6px}
    .score{display:flex;align-items:center;gap:10px;font-size:13px;color:#334155}
    .bar{flex:1;height:10px;background:#e2e8f0;border-radius:9999px;overflow:hidden}
    .bar > i{display:block;height:100%;} /* 背景色由 JS/Tailwind 填入 */
    .score b{width:92px;display:inline-block;color:#0f172a}
    .score em{width:36px;text-align:right;color:#475569;font-style:normal}
    .tags{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .tag{background:#eef2ff;color:#3730a3;padding:4px 10px;border-radius:9999px;font-size:12px}

    /* 列印樣式優化 */
    @media print {
        @page { margin: 14mm; }
        .no-print { display:none !important; }
        body { background:#fff !important; }
        .print-card { box-shadow:none !important; border:1px solid #e5e7eb; padding:12px; }
        /* 列印時的並排佈局：分數條 + 雷達圖 */
        .print-flex-container { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 15px; }
        .print-scores-section { flex: 1; min-width: 280px; }
        .print-chart-section { 
          flex: 1; min-width: 280px; max-width: 50%; 
          display: flex; justify-content: center; align-items: center; 
          border: 1px solid #e5e7eb; border-radius: 8px; padding: 5px; /* 添加邊框以區分圖表 */
        }
        .print-chart-section img { max-width: 100%; height: auto; }
        .print-scores-section h3 { margin-top: 12px; } /* 調整標題間距 */
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-5xl mx-auto p-6 space-y-5">
    <header class="no-print">
      <h1 class="text-2xl font-bold">仙人指路神獸七十二型人格｜一鍵分析</h1>
      <p class="text-slate-500 text-sm">選擇分析模式、對象與情境 → 按「一鍵分析」。支援分數條、雷達圖、列印 / 匯出 PDF。</p>
    </header>

        <div class="no-print">
        <div class="flex gap-4 mb-4">
            <button id="modePersonality" class="px-4 py-2 rounded-xl bg-slate-200 text-slate-800">個性分析</button>
            <button id="modeSingle" class="px-4 py-2 rounded-xl bg-slate-200 text-slate-800">單人分析</button>
            <button id="modeDual" class="px-4 py-2 rounded-xl bg-indigo-600 text-white">雙人分析</button>
        </div>
        <div class="grid md:grid-cols-2 gap-4">
                        <section class="bg-white p-4 rounded-2xl shadow-sm">
                <h2 class="font-semibold mb-3">我方 <span id="labelA" class="text-sm text-slate-500">(分析主體)</span></h2>
                <select id="aBeast" class="w-full mb-2 border rounded-lg p-2"></select>
                <select id="aKin" class="w-full mb-2 border rounded-lg p-2"></select>
                <select id="aBranch" class="w-full border rounded-lg p-2"></select>
            </section>

                        <section id="sectionB" class="bg-white p-4 rounded-2xl shadow-sm">
                <h2 class="font-semibold mb-3">對方</h2>
                <select id="bBeast" class="w-full mb-2 border rounded-lg p-2"></select>
                <select id="bKin" class="w-full mb-2 border rounded-lg p-2"></select>
                <select id="bBranch" class="w-full border rounded-lg p-2"></select>
            </section>
        </div>
    </div>

        <section id="contextSection" class="bg-white p-4 rounded-2xl shadow-sm space-y-2 no-print">
      <h2 class="font-semibold">情境</h2>
      <div class="flex gap-2 flex-wrap mb-2" id="contextPresets">
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">年度目標協調</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">績效回饋會議</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">跨部門協作</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">壓期交付專案</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">人際關係協調</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">愛情</button>
        <button class="preset px-3 py-1.5 rounded-full bg-slate-100">性愛</button>
      </div>
      <input id="context" class="w-full border rounded-lg p-2" placeholder="輸入情境…" />
            <div id="sexOptions" class="hidden mt-2 p-3 bg-red-50 border border-red-200 rounded-lg">
        <p class="font-semibold text-red-700 mb-2">性愛情境深入分析：</p>
        <div class="flex flex-wrap gap-2">
            <button class="sex-detail px-3 py-1.5 rounded-full bg-red-100" data-detail="情境描述">情境描述</button>
            <button class="sex-detail px-3 py-1.5 rounded-full bg-red-100" data-detail="姿勢建議">姿勢建議</button>
            <button class="sex-detail px-3 py-1.5 rounded-full bg-red-100" data-detail="對話引導">對話引導</button>
            <button class="sex-detail px-3 py-1.5 rounded-full bg-red-100" data-detail="感官探索">感官探索</button>
            <button class="sex-detail px-3 py-1.5 rounded-full bg-red-100" data-detail="角色扮演">角色扮演</button>
            <button class="sex-detail px-3 py-1.5 rounded-full bg-red-100" data-detail="深度連結">深度連結</button>
        </div>
        <textarea id="sexDetailInput" class="w-full mt-2 border rounded-lg p-2 text-sm" placeholder="輸入您想深入分析的細節，例如：『在海邊的夜晚』、『刺激的體位』、『挑逗的對話』…您也可以點選上方預設按鈕，我們會將關鍵詞加入到此處。"></textarea>
      </div>
    </section>

        <div class="flex flex-wrap items-center gap-3 no-print">
      <button id="go" class="px-4 py-2 rounded-xl bg-indigo-600 text-white font-semibold">一鍵分析</button>
      <button id="print" class="px-4 py-2 rounded-xl bg-slate-200 text-slate-800 font-semibold">列印 / 匯出 PDF</button>
      <span id="status" class="text-sm text-slate-600"></span>
    </div>

        <section class="bg-white p-5 rounded-2xl shadow-sm print-card">
      <div class="flex flex-wrap gap-2 text-sm text-slate-600 mb-3" id="chipsContainer">
        <span class="px-3 py-1 bg-slate-100 rounded-full">模式：<strong id="chipMode">—</strong></span>
        <span class="px-3 py-1 bg-slate-100 rounded-full">我方：<strong id="chipA">—</strong></span>
        <span id="chipB_wrapper" class="px-3 py-1 bg-slate-100 rounded-full">對方：<strong id="chipB">—</strong></span>
        <span id="chipC_wrapper" class="px-3 py-1 bg-slate-100 rounded-full">情境：<strong id="chipC">—</strong></span>
        <span id="chipSexDetail_wrapper" class="px-3 py-1 bg-slate-100 rounded-full hidden">深入：<strong id="chipSexDetail">—</strong></span>
      </div>
      <div id="result" class="prose max-w-none text-[15px]"></div>
      <div id="chartContainer" class="mt-4">
              </div>
    </section>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);

    let analysisMode = 'dual'; // 預設模式

    // 定義六獸、六親、地支
    const BEASTS = ['青龍', '朱雀', '勾陳', '螣蛇', '白虎', '玄武'];
    const KINS = ['父母', '兄弟', '子孫', '妻財', '官鬼'];
    const BRANCHES = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
    const DIMENSIONS = {
      fit: { label: '契合', color: '#22c55e' },  // 綠色
      comm: { label: '溝通', color: '#06b6d4' }, // 青色
      pace: { label: '節奏', color: '#f59e0b' }, // 橘色
      account: { label: '權責', color: '#8b5cf6' }, // 紫色
      trust: { label: '信任', color: '#ef4444' }, // 紅色
      innov: { label: '創新', color: '#6366f1' } // 藍色
    };

    // 輔助函式：填充 Select 元素
    function populateSelect(selectId, label, options) {
      const select = $(`#${selectId}`);
      select.innerHTML = `<option value="">${label}</option>`;
      options.forEach(opt => {
        select.innerHTML += `<option value="${opt}">${opt}</option>`;
      });
    }
    
    // 初始化所有 Select 元素
    function initSelects() {
      populateSelect('aBeast', '六獸', BEASTS);
      populateSelect('aKin', '六親', KINS);
      populateSelect('aBranch', '地支', BRANCHES);
      populateSelect('bBeast', '六獸', BEASTS);
      populateSelect('bKin', '六親', KINS);
      populateSelect('bBranch', '地支', BRANCHES);
    }

    // 生成六維度分數條的 HTML
    function generateScoresHTML(scores) {
      if (!scores || Object.values(scores).every(v => v === null || isNaN(v))) {
        return '';
      }
      const clamp = v => Math.max(0, Math.min(100, Number(v)||0));
      let html = `<h3 class=\"text-lg font-semibold mt-4\">六維度分數<\/h3><div class=\"scores\">`;

      Object.entries(DIMENSIONS).forEach(([key, { label, color }]) => {
        const value = clamp(scores[key]);
        html += `
          <div class=\"score\">
            <b>${label} ${key}<\/b>
            <div class=\"bar\"><i style=\"width:${value}%;background:${color}\"><\/i><\/div>
            <em>${value}<\/em>
          <\/div>
        `;
      });

      return html + `<\/div>`;
    }

    // 切換分析模式
    function setAnalysisMode(mode) {
      analysisMode = mode;
      
      // 重置所有按鈕樣式
      $$('#modePersonality, #modeSingle, #modeDual').forEach(btn => {
          btn.classList.remove('bg-indigo-600', 'text-white');
          btn.classList.add('bg-slate-200', 'text-slate-800');
      });
      // 設置當前模式按鈕樣式
      $(`#mode${mode.charAt(0).toUpperCase() + mode.slice(1)}`).classList.replace('bg-slate-200', 'bg-indigo-600');
      $(`#mode${mode.charAt(0).toUpperCase() + mode.slice(1)}`).classList.replace('text-slate-800', 'text-white');

      const contextEl = $('#contextSection');
      const sectionB = $('#sectionB');
      const labelA = $('#labelA');
      const chipBWrapper = $('#chipB_wrapper');
      const chipCWrapper = $('#chipC_wrapper');

      if (mode === 'personality') {
        sectionB.classList.add('hidden');
        contextEl.classList.add('hidden');
        labelA.textContent = '(分析對象)';
        // 清空對方欄位
        $('#bBeast').value = ''; $('#bKin').value = ''; $('#bBranch').value = '';
        chipBWrapper.classList.add('hidden');
        $('#context').value = ''; // 清空情境
        chipCWrapper.classList.add('hidden');
        toggleSexOptions(); // 確保性愛選項隱藏
      } else if (mode === 'single') {
        sectionB.classList.add('hidden');
        contextEl.classList.remove('hidden');
        labelA.textContent = '(分析主體)';
        // 清空對方欄位
        $('#bBeast').value = ''; $('#bKin').value = ''; $('#bBranch').value = '';
        chipBWrapper.classList.add('hidden');
        chipCWrapper.classList.remove('hidden');
      } else { // dual
        sectionB.classList.remove('hidden');
        contextEl.classList.remove('hidden');
        labelA.textContent = '';
        chipBWrapper.classList.remove('hidden');
        chipCWrapper.classList.remove('hidden');
      }
      updateChips(getSelections()); // 更新 chips 顯示
    }

    function toggleSexOptions() {
      const sexOptionsEl = $('#sexOptions');
      const chipSexDetailWrapper = $('#chipSexDetail_wrapper');
      
      if ($('#context').value.trim() === '性愛') {
        sexOptionsEl.classList.remove('hidden');
      } else {
        sexOptionsEl.classList.add('hidden');
        $('#sexDetailInput').value = ''; // 清空深入分析內容
        chipSexDetailWrapper.classList.add('hidden'); // 隱藏深入分析 chip
      }
    }

    function getSelections(){
      const contextInput = $('#context').value.trim();
      const sexDetailInput = $('#sexDetailInput').value.trim();
      
      return {
        mode: analysisMode,
        aBeast: $('#aBeast').value, aKin: $('#aKin').value, aBranch: $('#aBranch').value,
        bBeast: $('#bBeast').value, bKin: $('#bKin').value, bBranch: $('#bBranch').value,
        context: analysisMode === 'personality' ? '' : contextInput,
        sexDetail: contextInput === '性愛' ? sexDetailInput : '' // 只有情境是性愛才取深入細節
      };
    }

    function updateChips(selections){
      const {mode, aBeast,aKin,aBranch,bBeast,bKin,bBranch,context, sexDetail} = selections;
      
      $('#chipMode').textContent = {
        'personality': '個性分析', 'single': '單人分析', 'dual': '雙人分析'
      }[mode];
      
      $('#chipA').textContent = [aBeast, aKin, aBranch].filter(Boolean).join(' × ') || '—';

      const chipBWrapper = $('#chipB_wrapper');
      if (mode === 'dual') {
        $('#chipB').textContent = [bBeast, bKin, bBranch].filter(Boolean).join(' × ') || '—';
        chipBWrapper.classList.remove('hidden');
      } else {
        chipBWrapper.classList.add('hidden');
      }

      const chipCWrapper = $('#chipC_wrapper');
      if (mode !== 'personality') {
          $('#chipC').textContent = context || '—';
          chipCWrapper.classList.remove('hidden');
      } else {
          chipCWrapper.classList.add('hidden');
      }

      const chipSexDetailWrapper = $('#chipSexDetail_wrapper');
      if (sexDetail) {
          $('#chipSexDetail').textContent = sexDetail;
          chipSexDetailWrapper.classList.remove('hidden');
      } else {
          chipSexDetailWrapper.classList.add('hidden');
      }
    }

    // 文字→HTML排版＋JSON解析
    function formatOutputWithJson(text){
      if(!text) return { html: '', scores: null, tagsHTML: '' };

      const jsonBlock = text.match(/```json([\s\S]*?)```/i);
      let json = null;
      let cleanText = text;
      
      // 1. 解析 JSON 區塊
      if(jsonBlock){
        try{ json = JSON.parse(jsonBlock[1].trim()); }catch(e){ console.error("JSON Parse Error:", e); json = null; }
        cleanText = cleanText.replace(jsonBlock[0], '').trim();
      }

      // 2. 獲取分數 (優先從 JSON 獲取)
      let scores = null;
      if (json && json.scores && typeof json.scores === 'object') {
          scores = json.scores;
      } else {
          // 備用：從文本中匹配分數 (原邏輯，保留)
          const map = Object.keys(DIMENSIONS).reduce((acc, k) => ({...acc, [k]: null}), {});
          const rx = new RegExp(`(${Object.keys(DIMENSIONS).join('|')})\\s*(\\d{1,3})`, 'ig');
          let m; while((m = rx.exec(cleanText))){ map[m[1].toLowerCase()] = Number(m[2]); }
          const filled = Object.values(map).filter(v => typeof v === 'number' && !isNaN(v));
          if(filled.length > 0) scores = map; // 只要有一個有效分數就採用
      }

      // 3. 文本轉 HTML 排版
      let html = cleanText
        .replace(/\n\s*\n/g, '\n\n') // 確保段落間有換行
        .replace(/^\s*\d+\)\s*(.+)$/gm, '<h2>$1<\/h2>') // 二級標題 (改用 H2)
        .replace(/^\s*[*-]\s*(.+)$/gm, '<li>$1<\/li>') // 列表項
        .replace(/(?:^|\n)(?!<h2|<ul|<li>)([^\n]+)/g, '\n<p>$1</p>\n'); // 將沒有被轉換的行轉為段落 P
        
      // 轉換連續的 <li> 為 <ul>
      html = html.replace(/(<li>[^<]*<\/li>\n?)+/g, m => `<ul class="list-disc pl-5 space-y-1">${m}</ul>`);
      html = html.replace(/<p>\s*<\/p>/g, ''); // 移除空段落
      
      // 4. 標籤 HTML
      const tags = json && Array.isArray(json.tags) ? json.tags : [];
      const tagsHTML = tags.length ? `<div class=\"tags\">${tags.map(t=>`<span class=\"tag\">${t}</span>`).join('')}</div>` : '';
      
      return { html, scores, tagsHTML };
    }

    // Radar 圖
    let radarChart = null;
    function renderRadar(scores){
      const chartContainer = document.getElementById('chartContainer');
      chartContainer.innerHTML = ''; // 清空容器
      
      const scoresHTML = generateScoresHTML(scores);

      if(scores && Object.values(scores).some(v => v !== null && !isNaN(v) && v > 0)){ // 有有效分數才繪圖
          const chartCanvasHTML = `<div id="chart" class="w-full h-64 md:h-80"><canvas id="radar"></canvas></div>`;
          chartContainer.innerHTML = `
            <div class="print-flex-container">
              <div class="print-scores-section">${scoresHTML}</div>
              <div class="print-chart-section flex-1">${chartCanvasHTML}</div>
            </div>`;
          
          const clamp = v => Math.max(0, Math.min(100, Number(v)||0));
          const labels = Object.values(DIMENSIONS).map(d => d.label);
          const data = Object.keys(DIMENSIONS).map(key => clamp(scores[key]));
          
          const canvas = $('#radar');
          if(radarChart){ radarChart.destroy(); }
          window.radarChart = radarChart = new Chart(canvas.getContext('2d'), { // 將 chart 綁到 window 方便列印時取用
            type: 'radar', 
            data: { 
              labels, 
              datasets: [{ 
                label: '六維度雷達圖', 
                data, 
                fill: true, 
                backgroundColor: 'rgba(99,102,241,0.15)', 
                borderColor: 'rgba(99,102,241,1)', 
                pointBackgroundColor: 'rgba(99,102,241,1)'
              }] 
            },
            options: { 
              responsive: true, 
              maintainAspectRatio: false,
              scales: { 
                r: { 
                  suggestedMin: 0, 
                  suggestedMax: 100, 
                  ticks: { stepSize: 20 },
                  pointLabels: { font: { size: 14 } } // 調整標籤字體大小
                } 
              }, 
              plugins: { 
                legend: { display: false },
                tooltip: { enabled: true }
              } 
          });
      } else {
          // 沒有圖表時，只顯示分數條或空著
          chartContainer.innerHTML = scoresHTML;
      }
    }


    // 一鍵分析
    $('#go').onclick = async () => {
      const payload = getSelections(); updateChips(payload);
      let errorMessage = '';

      const aComplete = payload.aBeast && payload.aKin && payload.aBranch;
      const bComplete = payload.bBeast && payload.bKin && payload.bBranch;
      
      if (payload.mode === 'personality' && !aComplete) {
        errorMessage = '個性分析：請先選滿我方「六獸、六親、地支」';
      } else if (payload.mode === 'single' && (!aComplete || !payload.context)) {
        errorMessage = '單人分析：請先選滿我方「六獸、六親、地支」與情境';
      } else if (payload.mode === 'dual' && (!aComplete || !bComplete || !payload.context)) {
        errorMessage = '雙人分析：請先選滿我方/對方「六獸、六親、地支」與情境';
      }

      if (errorMessage) { alert(errorMessage); return; }

      $('#status').textContent = '分析中…'; 
      $('#result').innerHTML = ''; 
      $('#chartContainer').innerHTML = ''; 
      
      try {
        // 這裡應該是調用您的後端 API 
        // 假設您有一個 /api/analyze 端點
        const res = await fetch('/api/analyze', { 
          method: 'POST', 
          headers: {'Content-Type':'application/json'}, 
          body: JSON.stringify(payload) 
        });
        
        if (!res.ok) {
          throw new Error(`API 錯誤: ${res.status} ${res.statusText}`);
        }

        const data = await res.json();
        
        // 處理來自後端的結果文本
        let plain = data.text || data.result || JSON.stringify(data, null, 2);
        if(!plain && Array.isArray(data.output)){
          plain = data.output.map(o=> (o.content||[]).map(c=>c.text||'').join('\n')).join('\n');
        }
        
        const formatted = formatOutputWithJson(plain);
        
        $('#result').innerHTML = formatted.html + formatted.tagsHTML; 
        renderRadar(formatted.scores);
        
        $('#status').textContent = '✅ 完成';
      } catch (e) {
        $('#status').textContent = '❌ 分析失敗';
        $('#result').innerHTML = `<p class="text-red-600">分析過程中發生錯誤：${String(e.message || e)}</p>`;
        renderRadar(null); // 清除圖表
      }
    };

    // 列印 / 匯出 PDF
    $('#print').onclick = () => {
      const sel = getSelections(); updateChips(sel);
      
      // 獲取雷達圖快照
      let chartImg = '';
      if (window.radarChart && window.radarChart.canvas) {
          try {
              // 強制 re-render 一次以確保最新的狀態，雖然 toDataURL 一般足夠
              chartImg = window.radarChart.canvas.toDataURL('image/png');
          } catch (e) {
              console.error("Failed to get chart image data:", e);
          }
      }
      
      // 從結果區重新解析分數以生成列印用的分數條
      const currentResult = $('#result').innerHTML + $('#chartContainer').innerHTML;
      const { scores } = formatOutputWithJson(currentResult); 
      const scoresHTMLForPrint = generateScoresHTML(scores);

      // 準備晶片 (Chips) 的 HTML
      const chipHTML = `
        <span class=chip>模式：${{ 'personality': '個性分析', 'single': '單人分析', 'dual': '雙人分析' }[sel.mode]}</span>
        <span class=chip>我方：${[sel.aBeast, sel.aKin, sel.aBranch].filter(Boolean).join(' × ') || '—'}</span>
        ${sel.mode === 'dual' ? `<span class=chip>對方：${[sel.bBeast, sel.bKin, sel.bBranch].filter(Boolean).join(' × ') || '—'}</span>` : ''}
        ${sel.mode !== 'personality' ? `<span class=chip>情境：${sel.context || '—'}</span>` : ''}
        ${sel.context === '性愛' && sel.sexDetail ? `<span class=chip>深入：${sel.sexDetail}</span>` : ''}
      `.replace(/null|undefined/g, ''); // 移除可能的 null/undefined 字串

      // 組裝列印頁面的 HTML
      const html = `<!doctype html><html lang=\"zh-Hant\"><head><meta charset=\"utf-8\"><title>仙人指路分析結果列印</title>
      <style>
        /* (將您所有的 CSS 貼到這裡) */
        body{font-family:ui-sans-serif,system-ui,-apple-system,\"Noto Sans TC\";color:#0f172a;margin:18px;}
        h1{font-size:20px;margin:0 0 6px;}
        h2{font-size:16px;font-weight:600;margin:10px 0 4px}
        .meta{color:#64748b;font-size:12px;margin-bottom:10px}
        .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 14px}
        .chip{background:#eef2f7;border-radius:9999px;padding:6px 10px;font-size:12px;color:#0f172a}
        .box{border:1px solid #e5e7eb;border-radius:12px;padding:14px}
        .result{font-size:14px;line-height:1.6}
        ul{margin:6px 0 6px 18px;list-style:disc}
        p{margin:6px 0}
        
        /* 內聯分數條樣式 */
        .scores{display:grid;grid-template-columns:1fr;gap:8px;margin-top:6px}
        .score{display:flex;align-items:center;gap:10px;font-size:13px;color:#334155}
        .bar{flex:1;height:10px;background:#e2e8f0;border-radius:9999px;overflow:hidden}
        .bar>i{display:block;height:100%;}
        .score b{width:92px;display:inline-block;color:#0f172a}
        .score em{width:36px;text-align:right;color:#475569;font-style:normal}
        
        /* 內聯列印並排樣式 */
        .print-flex-container { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 15px; }
        .print-scores-section { flex: 1; min-width: 280px; }
        .print-chart-section { 
          flex: 1; min-width: 280px; max-width: 50%; 
          display: flex; justify-content: center; align-items: center; 
          border: 1px solid #e5e7eb; border-radius: 8px; padding: 5px;
        }
        .print-chart-section img { max-width: 100%; height: auto; }
        
        @page{margin:14mm}
      </style></head><body>
      <h1>仙人指路神獸七十二型人格分析結果</h1>
      <div class=meta>產生時間：${new Date().toLocaleString('zh-TW')}</div>
      <div class=chips>${chipHTML}</div>
      <div class=box>
        <div class=result>${$('#result').innerHTML || '<em>尚未產生結果</em>'}</div>
        ${(scoresHTMLForPrint || chartImg) ? `
          <div class="print-flex-container">
            ${scoresHTMLForPrint ? `<div class="print-scores-section">${scoresHTMLForPrint}</div>` : ''}
            ${chartImg ? `<div class="print-chart-section"><img src="${chartImg}" alt="雷達圖"></div>` : ''}
          </div>` : ''
        }
      </div>
      <script>window.onload=()=>window.print()<\/script></body></html>`;
      
      const w = window.open('', '_blank'); w.document.write(html); w.document.close();
    };

    // 事件監聽器：使用一個中央函式處理所有 Select 和 Input 的變化
    const selectorsToMonitor = ['#aBeast', '#aKin', '#aBranch', '#bBeast', '#bKin', '#bBranch', '#context', '#sexDetailInput'];
    selectorsToMonitor.forEach(selector => {
      const el = $(selector);
      if (el) {
        el.onchange = () => updateChips(getSelections());
        el.oninput = () => {
          if (selector === '#context') toggleSexOptions();
          updateChips(getSelections());
        };
      }
    });
    
    // 初始化
    initSelects();
    setAnalysisMode('dual'); // 預設為雙人模式
  </script>
</body>
</html>
