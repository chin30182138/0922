<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>六獸 AI 分析系統</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-pink-50 to-purple-50 text-gray-800 transition-colors duration-300">

  <div class="max-w-6xl mx-auto p-6">
    <h1 class="text-3xl font-bold text-center text-purple-700 mb-6">六獸 AI 分析系統</h1>

    <!-- 模式切換 -->
    <div class="flex justify-center gap-4 mb-6">
      <button onclick="switchMode('single')" id="btnSingle" class="px-4 py-2 bg-indigo-500 text-white rounded shadow">單人模式</button>
      <button onclick="switchMode('dual')" id="btnDual" class="px-4 py-2 bg-gray-300 text-black rounded shadow">雙人模式</button>
    </div>

    <!-- （這裡保留你原本的單人 / 雙人選單區塊，不刪減） -->

    <!-- 分析按鈕 -->
    <div class="flex gap-4 mb-6 flex-wrap">
      <button onclick="analyze('職場')" class="px-4 py-2 bg-blue-500 text-white rounded">職場分析</button>
      <button onclick="analyze('愛情')" class="px-4 py-2 bg-pink-500 text-white rounded">愛情分析</button>
      <button onclick="analyze('性愛')" class="px-4 py-2 bg-red-500 text-white rounded">性愛分析</button>
      <button onclick="analyze('個性')" class="px-4 py-2 bg-purple-600 text-white rounded">個性分析</button>
      <button onclick="openHistory()" class="px-4 py-2 bg-gray-700 text-white rounded">歷史紀錄</button>
    </div>

    <!-- 進度條 -->
    <div class="w-full bg-gray-200 rounded-full h-5 mb-4">
      <div id="progressBar" class="h-5 bg-gradient-to-r from-pink-500 to-purple-500 rounded-full text-xs text-white text-center leading-5">0%</div>
    </div>

    <!-- 分析結果 -->
    <div id="analysisResult" class="bg-white shadow rounded p-6 mb-6 min-h-[200px]"></div>

    <!-- 雷達圖 -->
    <div class="bg-white shadow rounded p-6 mb-6">
      <canvas id="radarChart"></canvas>
    </div>

    <!-- 功能 -->
    <div class="mt-6 text-center flex gap-4 justify-center">
      <button onclick="window.print()" class="px-6 py-2 bg-green-600 text-white rounded shadow">列印結果</button>
      <button onclick="downloadPDF()" class="px-6 py-2 bg-indigo-600 text-white rounded shadow">下載 PDF</button>
    </div>
  </div>

  <!-- 歷史紀錄側邊欄 -->
  <div id="historyPanel" class="fixed top-0 right-0 w-96 h-full bg-white shadow-lg transform translate-x-full transition-transform duration-300 overflow-y-auto z-50">
    <div class="p-4 border-b flex justify-between items-center">
      <h2 class="text-lg font-bold">分析歷史紀錄</h2>
      <button onclick="closeHistory()" class="text-red-500">✖</button>
    </div>
    <div class="p-4" id="historyList"></div>
    <div class="p-4 border-t">
      <button onclick="clearHistory()" class="w-full bg-red-600 text-white py-2 rounded">清空全部紀錄</button>
    </div>
  </div>

  <script>
    let currentMode = "single";
    const STORAGE_KEY = "sixBeastHistory";

    // 切換模式
    function switchMode(mode) {
      currentMode = mode;
      document.getElementById("singleMode").classList.toggle("hidden", mode !== "single");
      document.getElementById("dualMode").classList.toggle("hidden", mode !== "dual");
      document.getElementById("btnSingle").className = mode === "single" ? "px-4 py-2 bg-indigo-500 text-white rounded shadow" : "px-4 py-2 bg-gray-300 text-black rounded shadow";
      document.getElementById("btnDual").className = mode === "dual" ? "px-4 py-2 bg-indigo-500 text-white rounded shadow" : "px-4 py-2 bg-gray-300 text-black rounded shadow";
    }

    // 初始化雷達圖
    const ctx = document.getElementById('radarChart').getContext('2d');
    const radarChart = new Chart(ctx, {
      type: 'radar',
      data: {
        labels: ["情感", "事業", "健康", "財運", "智慧"],
        datasets: [{
          label: "能量分布",
          data: [5, 5, 5, 5, 5],
          backgroundColor: "rgba(255,99,132,0.5)",
          borderColor: "rgba(255,99,132,1)",
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { labels: { font: { size: 16 } } } },
        scales: { r: { min: 0, max: 10, ticks: { stepSize: 1, font: { size: 14 } }, pointLabels: { font: { size: 18 } } } }
      }
    });

    // 分析
    async function analyze(type) {
      const progress = document.getElementById("progressBar");
      let percent = 0;
      progress.style.width = "0%"; progress.textContent = "0%";
      const interval = setInterval(() => {
        if (percent < 90) { percent++; progress.style.width = percent + "%"; progress.textContent = percent + "%"; }
      }, 30);

      document.getElementById("analysisResult").innerHTML = `<p class="text-gray-500">分析中...請稍候</p>`;

      const body = { context: type, mode: currentMode };
      if (currentMode === "single") {
        body.singleBeast = document.getElementById("singleBeast").value;
        body.singleKin = document.getElementById("singleKin").value;
        body.singleBranch = document.getElementById("singleBranch").value;
      } else {
        body.aBeast = document.getElementById("aBeast").value;
        body.aKin = document.getElementById("aKin").value;
        body.aBranch = document.getElementById("aBranch").value;
        body.bBeast = document.getElementById("bBeast").value;
        body.bKin = document.getElementById("bKin").value;
        body.bBranch = document.getElementById("bBranch").value;
      }

      const response = await fetch("/api/analyze", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      const data = await response.json();

      clearInterval(interval);
      progress.style.width = "100%"; progress.textContent = "100%";

      document.getElementById("analysisResult").innerHTML = `<div class="mb-4 text-sm text-gray-500">${data.profile || ""}</div>${data.analysis}`;

      radarChart.data.datasets[0].data = [
        data.scores["情感"], data.scores["事業"], data.scores["健康"], data.scores["財運"], data.scores["智慧"]
      ];
      radarChart.update();

      saveHistory({ time: new Date().toLocaleString(), profile: data.profile, analysis: data.analysis, scores: data.scores });
    }

    // 儲存到 localStorage
    function saveHistory(entry) {
      let history = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
      history.unshift(entry);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
    }

    // 開啟歷史紀錄
    function openHistory() {
      document.getElementById("historyPanel").classList.remove("translate-x-full");
      renderHistory();
    }

    // 關閉歷史紀錄
    function closeHistory() {
      document.getElementById("historyPanel").classList.add("translate-x-full");
    }

    // 渲染歷史清單
    function renderHistory() {
      let history = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
      const list = document.getElementById("historyList");
      list.innerHTML = "";
      if (!history.length) {
        list.innerHTML = `<p class="text-gray-500">目前沒有紀錄</p>`;
        return;
      }
      history.forEach((h, idx) => {
        const item = document.createElement("div");
        item.className = "p-3 mb-3 border rounded bg-gray-50";
        item.innerHTML = `
          <div class="font-bold">${h.profile || "未命名"}</div>
          <div class="text-xs text-gray-500 mb-2">${h.time}</div>
          <button onclick="loadHistory(${idx})" class="px-2 py-1 bg-blue-500 text-white rounded text-xs">載入</button>
          <button onclick="deleteHistory(${idx})" class="px-2 py-1 bg-red-500 text-white rounded text-xs ml-2">刪除</button>
        `;
        list.appendChild(item);
      });
    }

    // 載入歷史
    function loadHistory(idx) {
      let history = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
      const h = history[idx];
      document.getElementById("analysisResult").innerHTML = `<div class="mb-4 text-sm text-gray-500">${h.profile}</div>${h.analysis}`;
      radarChart.data.datasets[0].data = [
        h.scores["情感"], h.scores["事業"], h.scores["健康"], h.scores["財運"], h.scores["智慧"]
      ];
      radarChart.update();
      closeHistory();
    }

    // 刪除單筆
    function deleteHistory(idx) {
      let history = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
      history.splice(idx, 1);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
      renderHistory();
    }

    // 清空全部
    function clearHistory() {
      if (confirm("確定要清空所有紀錄嗎？")) {
        localStorage.removeItem(STORAGE_KEY);
        renderHistory();
      }
    }

    // PDF 下載
    async function downloadPDF() {
      const { jsPDF } = window.jspdf;
      let filename = prompt("請輸入檔名：", "六獸分析.pdf");
      if (!filename.endsWith(".pdf")) filename += ".pdf";

      const doc = new jsPDF("p", "mm", "a4");
      const analysis = document.getElementById("analysisResult");
      const canvas1 = await html2canvas(analysis);
      const imgData1 = canvas1.toDataURL("image/png");
      doc.addImage(imgData1, "PNG", 10, 10, 190, 0);

      const canvas2 = document.getElementById("radarChart");
      const imgData2 = canvas2.toDataURL("image/png");
      doc.addImage(imgData2, "PNG", 10, 150, 180, 120);

      doc.save(filename);
    }
  </script>
</body>
</html>
